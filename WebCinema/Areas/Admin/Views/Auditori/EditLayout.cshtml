@model List<WebCinema.Models.Ghe>
@{
    var phongChieu = (WebCinema.Models.Phong_Chieu)ViewBag.PhongChieu;
    var loaiGheList = (List<WebCinema.Models.Loai_Ghe>)ViewBag.LoaiGheList;

    ViewBag.Title = "Chỉnh Sửa Sơ Đồ Ghế: " + phongChieu.ten_phong;
    Layout = "~/Areas/Admin/Views/Shared/LayoutAdmin.cshtml";
}

<style>
    /* Container chính */
    .seat-editor-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        margin-bottom: 30px;
    }

    .page-header {
        background: white;
        padding: 25px;
        border-radius: 10px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .page-header h2 {
        color: #333;
        margin: 0 0 15px 0;
        font-weight: 700;
        font-size: 28px;
    }

    .page-header h4 {
        color: #666;
        margin: 0 0 10px 0;
        font-weight: 500;
    }

    .instruction-box {
        background: #f8f9fa;
        padding: 15px 20px;
        border-left: 4px solid #667eea;
        border-radius: 5px;
        margin-top: 15px;
    }

    .instruction-box p {
        margin: 5px 0;
        color: #555;
        font-size: 14px;
    }

    /* Màn hình rạp */
    .screen-container {
        text-align: center;
        margin-bottom: 30px;
    }

    .screen {
        background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
        color: white;
        padding: 15px 80px;
        border-radius: 0 0 50% 50%;
        display: inline-block;
        font-weight: bold;
        font-size: 16px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        letter-spacing: 2px;
    }

    /* Công cụ toolbar */
    .tool-palette {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }

    .tool-palette > strong {
        display: block;
        margin-bottom: 20px;
        font-size: 18px;
        color: #333;
    }

    .tools-grid {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .tool-item {
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        position: relative;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .tool-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(0,0,0,0.2);
    }

    .tool-item.active {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }

    .tool-item.active::after {
        content: "✓";
        position: absolute;
        top: -8px;
        right: -8px;
        background: #28a745;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        border: 3px solid white;
    }

    /* Màu cho tool-item */
    .tool-item.tool-status-0 {
        background: #ecf0f1;
        border: 2px solid #bdc3c7;
        color: #7f8c8d;
    }

    .tool-item.tool-status-1 {
        background: #e74c3c;
        border: 2px solid #c0392b;
        color: white;
    }

    .tool-item.tool-loai-ghe-1 {
        background: #3498db;
        border: 2px solid #2980b9;
        color: white;
    }

    .tool-item.tool-loai-ghe-2 {
        background: #e74c3c;
        border: 2px solid #c0392b;
        color: white;
    }

    .tool-item.tool-loai-ghe-3 {
        background: #e83e8c;
        border: 2px solid #d6296d;
        color: white;
    }

    /* Sơ đồ ghế */
    .seat-layout-wrapper {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .seat-layout {
        display: grid;
        grid-template-columns: repeat(@phongChieu.so_cot, 50px);
        grid-gap: 10px;
        margin-top: 25px;
        justify-content: center;
        padding: 20px;
    }

    .seat {
        width: 50px;
        height: 50px;
        border-radius: 8px 8px 0 0;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 11px;
        font-weight: bold;
        transition: all 0.3s ease;
        position: relative;
        box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }

    .seat::before {
        content: "";
        position: absolute;
        bottom: -3px;
        left: 10%;
        right: 10%;
        height: 3px;
        background: inherit;
        filter: brightness(0.8);
        border-radius: 0 0 3px 3px;
    }

    .seat:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 8px 15px rgba(0,0,0,0.3);
    }

    /* Trạng thái ghế */
    .seat.status-0 {
        background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
        border: 2px dashed #bdc3c7;
        color: #95a5a6;
        box-shadow: none;
    }

    .seat.status-0::before {
        display: none;
    }

    .seat.status-1 {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        border: 2px solid #c0392b;
        color: white;
        opacity: 0.7;
    }

    .seat.status-2 {
        background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        color: white;
    }

    /* Loại ghế */
    .seat.status-2.loai-ghe-1 {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        border: 2px solid #2980b9;
    }

    .seat.status-2.loai-ghe-2 {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        border: 2px solid #c0392b;
    }

    .seat.status-2.loai-ghe-3 {
        background: linear-gradient(135deg, #e83e8c 0%, #d6296d 100%);
        border: 2px solid #d6296d;
    }

    /* Buttons */
    .action-buttons {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        text-align: center;
    }

    .btn-custom {
        padding: 12px 30px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 8px;
        transition: all 0.3s ease;
        border: none;
        margin: 0 10px;
    }

    .btn-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0,0,0,0.2);
    }

    .btn-save {
        background: linear-gradient(135deg, #28a745 0%, #20883b 100%);
        color: white;
    }

    .btn-back {
        background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        color: white;
    }

    /* Modal */
    .modal-content {
        border-radius: 10px;
        border: none;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px 10px 0 0;
        padding: 20px;
    }

    .modal-title {
        font-weight: 700;
    }

    .modal-body {
        padding: 25px;
    }

    .modal-footer {
        padding: 20px;
        border-top: 1px solid #eee;
    }
</style>

<div class="seat-editor-container">
    <div class="page-header">
        <h2><i class="glyphicon glyphicon-film"></i> Chỉnh Sửa Sơ Đồ Ghế</h2>
        <h4>🎭 Rạp: <strong>@phongChieu.Rap.ten_rap</strong> | 🎬 Phòng: <strong>@phongChieu.ten_phong</strong></h4>
        <div class="instruction-box">
            <p><strong>🖱️ Click (chuột trái)</strong> để áp dụng loại ghế đã chọn</p>
            <p><strong>🖱️ Double Click (nháy đúp)</strong> để sửa tên ghế</p>
        </div>
    </div>

    <div class="tool-palette">
        <strong>🎨 Chọn công cụ:</strong>
        <div class="tools-grid">
            <div class="tool-item tool-status-0 active" data-trang-thai="0" data-loai-ghe-id="1">
                🚶 Lối đi
            </div>

            @foreach (var loai in loaiGheList)
            {
                var icon = loai.loaighe_id == 1 ? "💺" : (loai.loaighe_id == 2 ? "👑" : "💖");
                <div class="tool-item tool-loai-ghe-@loai.loaighe_id" data-trang-thai="2" data-loai-ghe-id="@loai.loaighe_id">
                    @icon @loai.ten_loai
                </div>
            }

            <div class="tool-item tool-status-1" data-trang-thai="1" data-loai-ghe-id="1">
                ❌ Ghế hỏng
            </div>
        </div>
    </div>

    <div class="action-buttons">
        @using (Html.BeginForm("UpdateCapacity", "Auditori", FormMethod.Post, new { @style = "display: inline-block;" }))
        {
            @Html.Hidden("phong_chieu_id", phongChieu.phong_chieu_id)
            <button type="submit" class="btn btn-custom btn-save">
                <i class="glyphicon glyphicon-check"></i> Hoàn Tất & Cập nhật Sức Chứa
            </button>
        }
        @Html.ActionLink("← Quay lại danh sách", "Index", new { rapId = phongChieu.rap_id }, new { @class = "btn btn-custom btn-back" })
    </div>

    <div class="seat-layout-wrapper">
        <div class="screen-container">
            <div class="screen">MÀN HÌNH</div>
        </div>

        <div class="seat-layout-container" style="overflow-x: auto;">
            <div class="seat-layout">
                @foreach (var ghe in Model)
                {
                    <div class="seat status-@ghe.trang_thai loai-ghe-@ghe.loai_ghe_id"
                         data-ghe-id="@ghe.ghe_id"
                         data-trang-thai="@ghe.trang_thai"
                         data-so-ghe="@ghe.so_ghe"
                         data-loai-ghe-id="@ghe.loai_ghe_id">
                        @ghe.so_ghe
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editSeatModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: white; opacity: 1;">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">✏️ Chỉnh Sửa Tên Ghế</h4>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modal_ghe_id" />
                <div class="form-group">
                    <label for="modal_so_ghe" style="font-weight: 600; color: #333;">Tên ghế (ví dụ: A1, A2)</label>
                    <input type="text" id="modal_so_ghe" class="form-control" style="font-size: 16px; padding: 12px; border-radius: 6px;" />
                </div>
                <input type="hidden" id="modal_trang_thai" />
                <input type="hidden" id="modal_loai_ghe_id" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" style="padding: 10px 20px;">Đóng</button>
                <button type="button" class="btn btn-primary" id="saveSeatChanges" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                    <i class="glyphicon glyphicon-floppy-disk"></i> Lưu tên
                </button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
    $(document).ready(function () {

        var selectedSeatElement;

        // --- CẤU HÌNH TOOLBOX ---
        var activeTool = {
            trang_thai: 0,
            loai_ghe_id: 1
        };

        var firstTool = $('.tool-item.active');
        activeTool.trang_thai = firstTool.data('trang-thai');
        activeTool.loai_ghe_id = firstTool.data('loai-ghe-id');

        // 1. Khi nhấn vào một công cụ
        $('.tool-item').click(function() {
            $('.tool-item').removeClass('active');
            $(this).addClass('active');
            activeTool.trang_thai = $(this).data('trang-thai');
            activeTool.loai_ghe_id = $(this).data('loai-ghe-id');
        });

        // 2. KHI CLICK VÀO Ô GHẾ
        $('.seat').click(function () {
            selectedSeatElement = $(this);
            var soGheHienTai = selectedSeatElement.data('so-ghe');
            var newSoGhe = (activeTool.trang_thai == 0 || activeTool.trang_thai == 1) ? "" : soGheHienTai;

            var dataToSend = {
                ghe_id: selectedSeatElement.data('ghe-id'),
                trang_thai: activeTool.trang_thai,
                loai_ghe_id: activeTool.loai_ghe_id,
                so_ghe: newSoGhe
            };

            sendAjaxUpdate(dataToSend);
        });

        // 3. KHI DOUBLE CLICK VÀO Ô GHẾ
        $('.seat').dblclick(function() {
            selectedSeatElement = $(this);
            $('#modal_ghe_id').val(selectedSeatElement.data('ghe-id'));
            $('#modal_trang_thai').val(selectedSeatElement.data('trang-thai'));
            $('#modal_so_ghe').val(selectedSeatElement.data('so-ghe'));
            $('#modal_loai_ghe_id').val(selectedSeatElement.data('loai-ghe-id'));
            $('#editSeatModal').modal('show');
        });

        // 4. KHI LƯU TỪ MODAL
        $('#saveSeatChanges').click(function () {
            var dataToSend = {
                ghe_id: $('#modal_ghe_id').val(),
                trang_thai: $('#modal_trang_thai').val(),
                so_ghe: $('#modal_so_ghe').val(),
                loai_ghe_id: $('#modal_loai_ghe_id').val()
            };
            sendAjaxUpdate(dataToSend, true);
        });

        // HÀM AJAX
        function sendAjaxUpdate(dataToSend, fromModal = false) {
             $.ajax({
                url: '@Url.Action("UpdateGheDetails", "Auditori")',
                type: 'POST',
                data: dataToSend,
                success: function (response) {
                    if (response.success) {
                        selectedSeatElement.data('trang-thai', dataToSend.trang_thai);
                        selectedSeatElement.data('so-ghe', dataToSend.so_ghe);
                        selectedSeatElement.data('loai-ghe-id', dataToSend.loai_ghe_id);
                        selectedSeatElement.text(dataToSend.so_ghe);

                        selectedSeatElement.removeClass(function (index, className) {
                            return (className.match(/(^|\s)(status-\S+|loai-ghe-\S+)/g) || []).join(' ');
                        });

                        selectedSeatElement.addClass('status-' + dataToSend.trang_thai);

                        if (dataToSend.trang_thai == 2) {
                             selectedSeatElement.addClass('loai-ghe-' + dataToSend.loai_ghe_id);
                        }

                        if(fromModal) {
                            $('#editSeatModal').modal('hide');
                        }
                    } else {
                        alert("Lỗi: " + response.message);
                    }
                },
                error: function () {
                    alert("Đã xảy ra lỗi khi kết nối máy chủ.");
                }
            });
        }

    });
    </script>
}