using System;
using System.Linq;
using System.Web.Mvc;
using WebCinema.Models;
using WebCinema.Infrastructure;

namespace WebCinema.Areas.Admin.Controllers
{
    [RoleAuthorize(Roles = "Admin,Staff")]
    public class ShowtimeManagementController : Controller
    {
        private CSDLDataContext db = new CSDLDataContext();

        // GET: Admin/ShowtimeManagement
        public ActionResult Index(int? movieId, int? cinemaId, DateTime? date)
        {
            var showtimes = db.Suat_Chieus.AsQueryable();

            // Filter by movie
            if (movieId.HasValue)
            {
                showtimes = showtimes.Where(sc => sc.phim_id == movieId.Value);
            }

            // Filter by cinema
            if (cinemaId.HasValue)
            {
                showtimes = showtimes.Where(sc => sc.Phong_Chieu.rap_id == cinemaId.Value);
            }

            // Filter by date
            if (date.HasValue)
            {
                var targetDate = date.Value.Date;
                showtimes = showtimes.Where(sc => sc.ngay_chieu != null && 
                    sc.ngay_chieu.Value.Date == targetDate);
            }

            var result = showtimes
                .OrderByDescending(sc => sc.ngay_chieu)
                .ThenBy(sc => sc.ca_chieu_id)
                .ToList();

            ViewBag.Movies = new SelectList(db.Phims, "phim_id", "ten_phim", movieId);
            ViewBag.Cinemas = new SelectList(db.Raps, "rap_id", "ten_rap", cinemaId);
            ViewBag.MovieId = movieId;
            ViewBag.CinemaId = cinemaId;
            ViewBag.Date = date.HasValue ? date.Value.ToString("yyyy-MM-dd") : null;

            return View(result);
        }

        // GET: Admin/ShowtimeManagement/Create
        public ActionResult Create()
        {
            ViewBag.Movies = new SelectList(db.Phims, "phim_id", "ten_phim");
            ViewBag.Cinemas = new SelectList(db.Raps, "rap_id", "ten_rap");
            ViewBag.Shifts = new SelectList(db.Ca_Chieus, "ca_chieu_id", "ten_ca");
            
            return View();
        }

        // POST: Admin/ShowtimeManagement/Create
        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult Create(Suat_Chieu showtime, int cinemaId)
        {
            try
            {
                if (ModelState.IsValid)
                {
                    // Get rooms by cinema
                    var rooms = db.Phong_Chieus.Where(pc => pc.rap_id == cinemaId).ToList();
                    if (!rooms.Any())
                    {
                        TempData["ErrorMessage"] = "Rạp này chưa có phòng chiếu nào.";
                        ViewBag.Movies = new SelectList(db.Phims, "phim_id", "ten_phim");
                        ViewBag.Cinemas = new SelectList(db.Raps, "rap_id", "ten_rap");
                        ViewBag.Shifts = new SelectList(db.Ca_Chieus, "ca_chieu_id", "ten_ca");
                        return View(showtime);
                    }

                    // Check if showtime already exists
                    if (db.Suat_Chieus.Any(sc => sc.phong_chieu_id == showtime.phong_chieu_id &&
                        sc.ngay_chieu == showtime.ngay_chieu &&
                        sc.ca_chieu_id == showtime.ca_chieu_id))
                    {
                        TempData["ErrorMessage"] = "Suất chiếu này đã tồn tại.";
                        ViewBag.Movies = new SelectList(db.Phims, "phim_id", "ten_phim");
                        ViewBag.Cinemas = new SelectList(db.Raps, "rap_id", "ten_rap");
                        ViewBag.Rooms = new SelectList(rooms, "phong_chieu_id", "ten_phong", showtime.phong_chieu_id);
                        ViewBag.Shifts = new SelectList(db.Ca_Chieus, "ca_chieu_id", "ten_ca");
                        return View(showtime);
                    }

                    db.Suat_Chieus.InsertOnSubmit(showtime);
                    db.SubmitChanges();

                    TempData["SuccessMessage"] = "Thêm suất chiếu thành công!";
                    return RedirectToAction("Index");
                }
            }
            catch (Exception ex)
            {
                LoggingHelper.LogError(ex);
                TempData["ErrorMessage"] = "Có lỗi xảy ra: " + ex.Message;
            }

            ViewBag.Movies = new SelectList(db.Phims, "phim_id", "ten_phim");
            ViewBag.Cinemas = new SelectList(db.Raps, "rap_id", "ten_rap");
            ViewBag.Shifts = new SelectList(db.Ca_Chieus, "ca_chieu_id", "ten_ca");
            return View(showtime);
        }

        // GET: Admin/ShowtimeManagement/Edit/5
        public ActionResult Edit(int id)
        {
            var showtime = db.Suat_Chieus.FirstOrDefault(sc => sc.suat_chieu_id == id);
            if (showtime == null)
            {
                return HttpNotFound();
            }

            ViewBag.Movies = new SelectList(db.Phims, "phim_id", "ten_phim", showtime.phim_id);
            ViewBag.Cinemas = new SelectList(db.Raps, "rap_id", "ten_rap", showtime.Phong_Chieu.rap_id);
            ViewBag.Rooms = new SelectList(db.Phong_Chieus.Where(pc => pc.rap_id == showtime.Phong_Chieu.rap_id), 
                "phong_chieu_id", "ten_phong", showtime.phong_chieu_id);
            ViewBag.Shifts = new SelectList(db.Ca_Chieus, "ca_chieu_id", "ten_ca", showtime.ca_chieu_id);

            return View(showtime);
        }

        // POST: Admin/ShowtimeManagement/Edit/5
        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult Edit(int id, FormCollection form)
        {
            try
            {
                var showtime = db.Suat_Chieus.FirstOrDefault(sc => sc.suat_chieu_id == id);
                if (showtime == null)
                {
                    return HttpNotFound();
                }

                showtime.phim_id = int.Parse(form["phim_id"]);
                showtime.phong_chieu_id = int.Parse(form["phong_chieu_id"]);
                showtime.ca_chieu_id = int.Parse(form["ca_chieu_id"]);
                
                if (!string.IsNullOrEmpty(form["ngay_chieu"]))
                {
                    showtime.ngay_chieu = DateTime.Parse(form["ngay_chieu"]);
                }

                db.SubmitChanges();

                TempData["SuccessMessage"] = "Cập nhật suất chiếu thành công!";
                return RedirectToAction("Index");
            }
            catch (Exception ex)
            {
                LoggingHelper.LogError(ex);
                TempData["ErrorMessage"] = "Có lỗi xảy ra: " + ex.Message;
            }

            return RedirectToAction("Edit", new { id });
        }

        // POST: Admin/ShowtimeManagement/Delete/5
        [HttpPost]
        public ActionResult Delete(int id)
        {
            try
            {
                var showtime = db.Suat_Chieus.FirstOrDefault(sc => sc.suat_chieu_id == id);
                if (showtime == null)
                {
                    return Json(new { success = false, message = "Suất chiếu không tồn tại." });
                }

                // Check if showtime has bookings - Ve_Phim might not have direct relation
                // Check through Dat_Ve instead
                var hasBookings = db.Ve_Phims.Any(vp => vp.suat_chieu_id == id);
                if (hasBookings)
                {
                    return Json(new { success = false, message = "Không thể xóa suất chiếu đã có vé đặt." });
                }

                db.Suat_Chieus.DeleteOnSubmit(showtime);
                db.SubmitChanges();

                return Json(new { success = true, message = "Xóa suất chiếu thành công!" });
            }
            catch (Exception ex)
            {
                LoggingHelper.LogError(ex);
                return Json(new { success = false, message = "Có lỗi xảy ra: " + ex.Message });
            }
        }

        // AJAX: Get rooms by cinema
        [HttpGet]
        public JsonResult GetRoomsByCinema(int cinemaId)
        {
            try
            {
                var rooms = db.Phong_Chieus
                    .Where(pc => pc.rap_id == cinemaId)
                    .Select(pc => new { 
                        value = pc.phong_chieu_id, 
                        text = pc.ten_phong 
                    })
                    .ToList();

                return Json(new { success = true, rooms }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                LoggingHelper.LogError(ex);
                return Json(new { success = false, message = ex.Message }, JsonRequestBehavior.AllowGet);
            }
        }

        protected override void Dispose(bool disposing)
        {
            if (disposing)
            {
                db.Dispose();
            }
            base.Dispose(disposing);
        }
    }
}
